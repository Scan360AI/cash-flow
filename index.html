<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Cassa</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Header con saldi -->
        <header class="app-header">
            <h1 class="header-title">Gestione Cassa</h1>
            <div class="saldi-container">
                <div class="saldo-card">
                    <div class="saldo-label">Saldo Contabile</div>
                    <div class="saldo-value" id="saldo-contabile">‚Ç¨ 0,00</div>
                </div>
                <div class="saldo-card">
                    <div class="saldo-label">Saldo Disponibile</div>
                    <div class="saldo-value" id="saldo-disponibile">‚Ç¨ 0,00</div>
                </div>
            </div>
        </header>

        <!-- Sidebar con form -->
        <aside class="app-sidebar">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Nuovo Movimento</h2>
                </div>
                <div class="card-content">
                    <form id="movimento-form">
                        <div class="form-group">
                            <label class="form-label" for="data">Data</label>
                            <input type="date" id="data" class="form-input" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="descrizione">Descrizione</label>
                            <input type="text" id="descrizione" class="form-input" required 
                                   placeholder="Es: Pagamento fornitore">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="importo">Importo (‚Ç¨)</label>
                            <input type="number" id="importo" class="form-input" 
                                   step="0.01" min="0.01" required placeholder="0,00">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="tipo">Tipo</label>
                            <select id="tipo" class="form-select" required>
                                <option value="">Seleziona tipo</option>
                                <option value="entrata">Entrata</option>
                                <option value="uscita">Uscita</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="categoria">Categoria</label>
                            <select id="categoria" class="form-select" required>
                                <option value="">Seleziona categoria</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="stato">Stato</label>
                            <select id="stato" class="form-select" required>
                                <option value="previsto">Previsto</option>
                                <option value="eseguito">Eseguito</option>
                                <option value="annullato">Annullato</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="btn btn-primary btn-lg" style="width: 100%;">
                            <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
                            <span id="form-submit-text">Aggiungi Movimento</span>
                        </button>
                        
                        <button type="button" id="cancel-edit" class="btn btn-secondary" 
                                style="width: 100%; margin-top: 0.5rem; display: none;">
                            <i data-lucide="x" style="width: 16px; height: 16px;"></i>
                            Annulla Modifica
                        </button>
                    </form>
                </div>
            </div>

            <!-- Impostazioni saldi -->
            <div class="card" style="margin-top: 2rem;">
                <div class="card-header">
                    <h2 class="card-title">Impostazioni</h2>
                </div>
                <div class="card-content">
                    <div class="form-group">
                        <label class="form-label" for="saldo-iniziale">Saldo Iniziale (‚Ç¨)</label>
                        <input type="number" id="saldo-iniziale" class="form-input" 
                               step="0.01" placeholder="0,00">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="limite-scoperto">Limite Scoperto (‚Ç¨)</label>
                        <input type="number" id="limite-scoperto" class="form-input" 
                               step="0.01" min="0" placeholder="0,00">
                    </div>
                    
                    <button type="button" id="salva-impostazioni" class="btn btn-secondary" 
                            style="width: 100%;">
                        <i data-lucide="save" style="width: 16px; height: 16px;"></i>
                        Salva Impostazioni
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main content -->
        <main class="app-main">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Movimenti</h2>
                </div>
                <div class="card-content" style="padding: 0;">
                    <div class="table-container">
                        <table class="movimenti-table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Descrizione</th>
                                    <th>Categoria</th>
                                    <th>Importo</th>
                                    <th>Tipo</th>
                                    <th>Stato</th>
                                    <th>Saldo Contabile</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="movimenti-tbody">
                                <!-- Movimenti generati dinamicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal per conferme -->
    <div id="modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Conferma</h3>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p id="modal-message">Sei sicuro?</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="modal-cancel">Annulla</button>
                <button class="btn btn-danger" id="modal-confirm">Conferma</button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="config.js"></script>
    <script>
        // === CONFIGURAZIONE DEFINITIVA ===
        // Definisce la configurazione in modo che sia sempre disponibile
        window.SUPABASE_CONFIG = window.SUPABASE_CONFIG || SUPABASE_CONFIG || {
            url: 'https://pnrjsisykqzwvcdjdyri.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBucmpzaXN5a3F6d3ZjZGpkeXJpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MDM5MzAsImV4cCI6MjA3NDM3OTkzMH0.vpauNA2NYZlA9vIW7SItUvM3GuOxLAvFLdUQehNCQ-0'
        };
        
        window.APP_CONFIG = window.APP_CONFIG || APP_CONFIG || {
            maxFutureMonths: 12,
            defaultCurrency: '‚Ç¨',
            dateFormat: 'DD/MM/YYYY'
        };
        
        window.CONFIG_UTILS = window.CONFIG_UTILS || CONFIG_UTILS || {
            formatCurrency: (amount) => {
                return new Intl.NumberFormat('it-IT', {
                    style: 'currency',
                    currency: 'EUR',
                    minimumFractionDigits: 2
                }).format(amount);
            },
            formatDate: (date) => {
                return new Date(date).toLocaleDateString('it-IT');
            },
            parseDate: (dateString) => {
                const [day, month, year] = dateString.split('/');
                return new Date(year, month - 1, day).toISOString().split('T')[0];
            }
        };
        
        console.log('‚úÖ Configurazione caricata:', {
            url: window.SUPABASE_CONFIG.url,
            keyLength: window.SUPABASE_CONFIG.key.length
        });
        // === STATO GLOBALE ===
        let supabase;
        let app = {
            movimenti: [],
            categorie: [],
            settings: {
                saldoIniziale: 0,
                limiteScoperto: 0
            },
            saldoContabile: 0,
            saldoDisponibile: 0,
            editingId: null,
            isInitialized: false
        };

        // === INIZIALIZZAZIONE ===
        document.addEventListener('DOMContentLoaded', init);

        async function init() {
            try {
                // Previeni inizializzazione multipla
                if (app.isInitialized) {
                    console.log('‚ö†Ô∏è App gi√† inizializzata, ignorando...');
                    return;
                }
                
                // Controlla se Supabase √® caricato
                if (typeof window.supabase === 'undefined') {
                    throw new Error('Libreria Supabase non caricata. Controlla la connessione internet.');
                }
                
                // La configurazione √® ora sempre disponibile
                const config = window.SUPABASE_CONFIG;
                console.log('üîß Usando configurazione:', config.url);
                
                // Inizializza Supabase
                console.log('Inizializzando Supabase...');
                const { createClient } = window.supabase;
                window.supabaseClient = createClient(config.url, config.key);
                
                console.log('‚úÖ Client Supabase creato');
                
                // Test connessione semplice
                console.log('Testando connessione Supabase...');
                const { data, error } = await window.supabaseClient
                    .from('settings')
                    .select('*', { count: 'exact', head: true });
                
                if (error && !['PGRST106', '42P01'].includes(error.code)) {
                    // PGRST106 = table not found, 42P01 = table does not exist
                    // Entrambi significano connessione OK ma tabella mancante
                    console.warn('Possibile problema connessione:', error);
                    throw new Error(`Errore connessione database: ${error.message}. Verifica le credenziali Supabase.`);
                }
                
                if (error && ['PGRST106', '42P01'].includes(error.code)) {
                    console.log('‚ö†Ô∏è Tabelle non trovate (normale al primo avvio)');
                    
                    // Mostra messaggio per creare le tabelle
                    showSetupMessage();
                    return; // Non continuare se le tabelle non esistono
                }
                
                console.log('‚úÖ Connessione Supabase OK');
                
                // Carica dati iniziali
                try {
                    await loadCategorie();
                    await loadSettings();
                    await loadMovimenti();
                } catch (dbError) {
                    console.warn('Errore caricamento dati:', dbError);
                    if (dbError.code === 'PGRST106' || dbError.code === '42P01') {
                        showSetupMessage();
                        return; // Non continuare se le tabelle non esistono
                    }
                    throw dbError;
                }
                
                // Setup event listeners (SOLO UNA VOLTA)
                setupEventListeners();
                
                // Imposta data odierna come default
                document.getElementById('data').valueAsDate = new Date();
                
                // Marca come inizializzata
                app.isInitialized = true;
                
                console.log('‚úÖ App inizializzata correttamente');
                
                // Mostra messaggio di successo
                const headerTitle = document.querySelector('.header-title');
                headerTitle.style.color = '#10b981';
                setTimeout(() => {
                    headerTitle.style.color = '';
                }, 2000);
                
            } catch (error) {
                console.error('Errore inizializzazione:', error);
                
                // Mostra errore nell'interfaccia
                const headerTitle = document.querySelector('.header-title');
                headerTitle.textContent = `‚ùå ${error.message}`;
                headerTitle.style.color = '#ef4444';
                
                // Nascondi il resto dell'interfaccia
                document.querySelector('.app-sidebar').style.display = 'none';
                document.querySelector('.app-main').innerHTML = `
                    <div class="card">
                        <div class="card-content" style="text-align: center; padding: 3rem;">
                            <h2 style="color: #ef4444; margin-bottom: 1rem;">üö® Errore di Inizializzazione</h2>
                            <p style="margin-bottom: 1rem; color: #6b7280;">${error.message}</p>
                            <p style="font-size: 0.875rem; color: #9ca3af; margin-bottom: 1rem;">
                                Controlla la console del browser (F12) per maggiori dettagli.
                            </p>
                            <button onclick="location.reload()" class="btn btn-primary" style="margin-top: 1rem;">
                                üîÑ Ricarica Pagina
                            </button>
                            <button onclick="window.open('test-connection.html', '_blank')" class="btn btn-secondary" style="margin-top: 1rem; margin-left: 1rem;">
                                üîß Test Connessione
                            </button>
                        </div>
                    </div>
                `;
                
                alert(`üö® Errore: ${error.message}\n\nControlla la console per dettagli.`);
            }
        }
        
        function showSetupMessage() {
            document.querySelector('.app-sidebar').style.display = 'none';
            document.querySelector('.app-main').innerHTML = `
                <div class="card">
                    <div class="card-content" style="text-align: center; padding: 3rem;">
                        <h2 style="color: #f59e0b; margin-bottom: 1rem;">‚ö° Setup Necessario</h2>
                        <p style="margin-bottom: 1rem; color: #6b7280;">
                            Connessione Supabase OK, ma le tabelle del database non esistono ancora.
                        </p>
                        <p style="margin-bottom: 2rem; color: #9ca3af; font-size: 0.875rem;">
                            Devi creare le tabelle nel database prima di usare l'app.
                        </p>
                        
                        <div style="background: #f3f4f6; padding: 1.5rem; border-radius: 8px; text-align: left; margin-bottom: 2rem;">
                            <h3 style="margin-bottom: 1rem; color: #374151;">üìã Passi da seguire:</h3>
                            <ol style="color: #6b7280; line-height: 1.6;">
                                <li>Vai su <strong>Supabase Dashboard</strong></li>
                                <li>Seleziona il tuo progetto</li>
                                <li>Vai in <strong>SQL Editor</strong></li>
                                <li>Esegui le query SQL per creare le tabelle</li>
                                <li>Torna qui e ricarica la pagina</li>
                            </ol>
                        </div>
                        
                        <button onclick="window.open('https://supabase.com/dashboard', '_blank')" class="btn btn-primary">
                            üöÄ Apri Supabase Dashboard
                        </button>
                        <button onclick="location.reload()" class="btn btn-secondary" style="margin-left: 1rem;">
                            üîÑ Ricarica Dopo Setup
                        </button>
                        <button onclick="window.open('test-connection.html', '_blank')" class="btn btn-secondary" style="margin-left: 1rem;">
                            üîß Strumenti di Test
                        </button>
                    </div>
                </div>
            `;
        }

        // === DATABASE FUNCTIONS ===
        async function loadCategorie() {
            console.log('Caricando categorie...');
            const { data, error } = await window.supabaseClient
                .from('categorie')
                .select('*')
                .eq('attiva', true)
                .order('tipo', { ascending: true })
                .order('nome', { ascending: true });
            
            if (error) {
                console.error('Errore caricamento categorie:', error);
                throw error;
            }
            
            console.log('Categorie caricate:', data);
            app.categorie = data || [];
            updateCategorieSelect();
        }

        async function loadSettings() {
            console.log('Caricando impostazioni...');
            const { data, error } = await window.supabaseClient
                .from('settings')
                .select('*')
                .limit(1);
            
            if (error) {
                console.error('Errore caricamento settings:', error);
                throw error;
            }
            
            console.log('Settings caricati:', data);
            if (data && data.length > 0) {
                app.settings = {
                    saldoIniziale: parseFloat(data[0].saldo_iniziale) || 0,
                    limiteScoperto: parseFloat(data[0].limite_scoperto) || 0
                };
            }
            
            updateSettingsForm();
        }

        async function loadMovimenti() {
            console.log('Caricando movimenti...');
            const { data, error } = await window.supabaseClient
                .from('movimenti')
                .select(`
                    *,
                    categoria:categorie(nome, colore)
                `)
                .order('data', { ascending: true })
                .order('posizione_ordinamento', { ascending: true });
            
            if (error) {
                console.error('Errore caricamento movimenti:', error);
                throw error;
            }
            
            console.log('Movimenti caricati:', data);
            app.movimenti = data || [];
            renderTabella();
            updateSaldi();
        }

        async function saveMovimento(movimento) {
            console.log('üîÑ Salvando movimento:', movimento);
            
            const { data, error } = await window.supabaseClient
                .from('movimenti')
                .insert([movimento])
                .select();
            
            if (error) {
                console.error('‚ùå Errore salvataggio movimento:', error);
                throw error;
            }
            
            console.log('‚úÖ Movimento salvato:', data);
            await loadMovimenti(); // Ricarica tutti i movimenti
            return data[0];
        }

        async function updateMovimento(id, updates) {
            console.log('Aggiornando movimento:', id, updates);
            const { data, error } = await window.supabaseClient
                .from('movimenti')
                .update(updates)
                .eq('id', id)
                .select();
            
            if (error) {
                console.error('Errore aggiornamento movimento:', error);
                throw error;
            }
            
            console.log('Movimento aggiornato:', data);
            await loadMovimenti();
            return data[0];
        }

        async function deleteMovimento(id) {
            console.log('Eliminando movimento:', id);
            const { error } = await window.supabaseClient
                .from('movimenti')
                .delete()
                .eq('id', id);
            
            if (error) {
                console.error('Errore eliminazione movimento:', error);
                throw error;
            }
            
            console.log('Movimento eliminato');
            await loadMovimenti();
        }

        async function duplicateMovimento(movimento) {
            const duplicato = {
                data: movimento.data,
                descrizione: `${movimento.descrizione} (copia)`,
                importo: movimento.importo,
                categoria_id: movimento.categoria_id,
                tipo: movimento.tipo,
                stato: 'previsto', // Sempre previsto per i duplicati
                posizione_ordinamento: movimento.posizione_ordinamento
            };
            
            console.log('Duplicando movimento:', duplicato);
            return await saveMovimento(duplicato);
        }

        async function saveSettings() {
            const settings = {
                saldo_iniziale: parseFloat(document.getElementById('saldo-iniziale').value) || 0,
                limite_scoperto: parseFloat(document.getElementById('limite-scoperto').value) || 0,
                updated_at: new Date().toISOString()
            };

            console.log('Salvando impostazioni:', settings);
            const { error } = await window.supabaseClient
                .from('settings')
                .upsert(settings);
            
            if (error) {
                console.error('Errore salvataggio settings:', error);
                throw error;
            }
            
            console.log('Impostazioni salvate');
            app.settings.saldoIniziale = settings.saldo_iniziale;
            app.settings.limiteScoperto = settings.limite_scoperto;
            
            updateSaldi();
        }

        // === UI FUNCTIONS ===
        function updateCategorieSelect() {
            const select = document.getElementById('categoria');
            const currentValue = select.value;
            
            // Mantieni prima opzione
            const firstOption = select.children[0];
            select.innerHTML = '';
            select.appendChild(firstOption);
            
            // Aggiungi categorie per tipo
            ['entrata', 'uscita'].forEach(tipo => {
                const categorieTipo = app.categorie.filter(c => c.tipo === tipo);
                if (categorieTipo.length > 0) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = tipo.charAt(0).toUpperCase() + tipo.slice(1) + 'e';
                    
                    categorieTipo.forEach(categoria => {
                        const option = document.createElement('option');
                        option.value = categoria.id;
                        option.textContent = categoria.nome;
                        optgroup.appendChild(option);
                    });
                    
                    select.appendChild(optgroup);
                }
            });
            
            // Ripristina valore se possibile
            if (currentValue) select.value = currentValue;
        }

        function updateSettingsForm() {
            document.getElementById('saldo-iniziale').value = app.settings.saldoIniziale;
            document.getElementById('limite-scoperto').value = app.settings.limiteScoperto;
        }

        function renderTabella() {
            const tbody = document.getElementById('movimenti-tbody');
            
            if (app.movimenti.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 3rem; color: var(--gray-500);">
                            Nessun movimento presente. Aggiungi il primo movimento dal form a sinistra.
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Ordina movimenti per data (cronologico per calcolo saldo progressivo)
            const movimentiOrdinati = [...app.movimenti].sort((a, b) => {
                const dateA = new Date(a.data);
                const dateB = new Date(b.data);
                if (dateA.getTime() === dateB.getTime()) {
                    return (a.posizione_ordinamento || 0) - (b.posizione_ordinamento || 0);
                }
                return dateA - dateB;
            });
            
            // Calcola saldi progressivi
            let saldoProgressivo = app.settings.saldoIniziale;
            
            const movimentiConSaldo = movimentiOrdinati.map(movimento => {
                // Calcola nuovo saldo solo per movimenti non annullati
                if (movimento.stato !== 'annullato') {
                    if (movimento.tipo === 'entrata') {
                        saldoProgressivo += Math.abs(parseFloat(movimento.importo));
                    } else if (movimento.tipo === 'uscita') {
                        saldoProgressivo -= Math.abs(parseFloat(movimento.importo));
                    }
                }
                
                // Determina colore saldo
                let saldoClass = '';
                let saldoIcon = '';
                
                if (saldoProgressivo >= 0) {
                    saldoClass = 'saldo-positivo';
                    saldoIcon = 'check-circle';
                } else if (saldoProgressivo > -app.settings.limiteScoperto) {
                    saldoClass = 'saldo-allerta';
                    saldoIcon = 'alert-triangle';
                } else {
                    saldoClass = 'saldo-critico';
                    saldoIcon = 'x-circle';
                }
                
                return {
                    ...movimento,
                    saldoProgressivo,
                    saldoClass,
                    saldoIcon
                };
            });
            
            tbody.innerHTML = movimentiConSaldo.map(movimento => `
                <tr class="movimento-row" draggable="true" data-id="${movimento.id}">
                    <td>${window.CONFIG_UTILS.formatDate(movimento.data)}</td>
                    <td>${movimento.descrizione}</td>
                    <td>
                        <span class="categoria-badge" style="background-color: ${movimento.categoria?.colore || '#e5e7eb'}20; border-color: ${movimento.categoria?.colore || '#d1d5db'};">
                            ${movimento.categoria?.nome || 'N/A'}
                        </span>
                    </td>
                    <td class="${movimento.tipo === 'entrata' ? 'tipo-entrata' : 'tipo-uscita'}">
                        ${movimento.tipo === 'entrata' ? '+' : '‚àí'}${window.CONFIG_UTILS.formatCurrency(Math.abs(movimento.importo))}
                    </td>
                    <td class="${movimento.tipo === 'entrata' ? 'tipo-entrata' : 'tipo-uscita'}">
                        ${movimento.tipo.charAt(0).toUpperCase() + movimento.tipo.slice(1)}
                    </td>
                    <td>
                        <span class="status-badge status-${movimento.stato}">
                            ${movimento.stato}
                        </span>
                    </td>
                    <td class="saldo-progressivo ${movimento.saldoClass}">
                        <div class="saldo-container">
                            <i data-lucide="${movimento.saldoIcon}" class="saldo-icon"></i>
                            <span class="saldo-amount">${window.CONFIG_UTILS.formatCurrency(movimento.saldoProgressivo)}</span>
                        </div>
                    </td>
                    <td class="actions-cell">
                        <div class="action-buttons">
                            <button class="btn-icon ${movimento.stato === 'eseguito' ? 'executed' : 'pending'}" 
                                    onclick="toggleEseguito('${movimento.id}')" 
                                    title="${movimento.stato === 'eseguito' ? 'Segna come previsto' : 'Segna come eseguito'}">
                                <i data-lucide="${movimento.stato === 'eseguito' ? 'check-circle-2' : 'circle'}" 
                                   style="width: 14px; height: 14px;"></i>
                            </button>
                            <button class="btn-icon ${movimento.is_modificato ? 'locked' : 'unlocked'}" 
                                    onclick="toggleBloccato('${movimento.id}')" 
                                    title="${movimento.is_modificato ? 'Sblocca movimento' : 'Blocca movimento'}">
                                <i data-lucide="${movimento.is_modificato ? 'lock' : 'unlock'}" 
                                   style="width: 14px; height: 14px;"></i>
                            </button>
                            <button class="btn-icon edit" 
                                    onclick="editMovimento('${movimento.id}')" 
                                    title="Modifica" 
                                    ${movimento.is_modificato ? 'disabled' : ''}>
                                <i data-lucide="edit" style="width: 14px; height: 14px;"></i>
                            </button>
                            <button class="btn-icon duplicate" 
                                    onclick="duplicateMovimentoAction('${movimento.id}')" 
                                    title="Duplica">
                                <i data-lucide="copy" style="width: 14px; height: 14px;"></i>
                            </button>
                            <button class="btn-icon delete" 
                                    onclick="confirmDelete('${movimento.id}')" 
                                    title="Elimina"
                                    ${movimento.is_modificato ? 'disabled' : ''}>
                                <i data-lucide="trash-2" style="width: 14px; height: 14px;"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            // Inizializza le icone Lucide
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
            
            // Riabilita drag & drop
            initDragDrop();
        }

        function updateSaldi() {
            // Considera solo movimenti non annullati
            const movimentiValidi = app.movimenti.filter(m => m.stato !== 'annullato');
            
            const entrate = movimentiValidi
                .filter(m => m.tipo === 'entrata')
                .reduce((sum, m) => sum + Math.abs(parseFloat(m.importo)), 0);
            
            const uscite = movimentiValidi
                .filter(m => m.tipo === 'uscita')
                .reduce((sum, m) => sum + Math.abs(parseFloat(m.importo)), 0);
            
            app.saldoContabile = app.settings.saldoIniziale + entrate - uscite;
            app.saldoDisponibile = app.saldoContabile - app.settings.limiteScoperto;
            
            // Aggiorna UI
            const saldoContabileEl = document.getElementById('saldo-contabile');
            const saldoDisponibileEl = document.getElementById('saldo-disponibile');
            
            saldoContabileEl.textContent = window.CONFIG_UTILS.formatCurrency(app.saldoContabile);
            saldoDisponibileEl.textContent = window.CONFIG_UTILS.formatCurrency(app.saldoDisponibile);
            
            // Applica classi colore
            saldoContabileEl.className = 'saldo-value ' + (app.saldoContabile >= 0 ? 'positive' : 'negative');
            saldoDisponibileEl.className = 'saldo-value ' + 
                (app.saldoDisponibile >= 0 ? 'positive' : app.saldoDisponibile < -app.settings.limiteScoperto ? 'negative' : 'warning');
        }

        // === FORM HANDLERS ===
        function resetForm() {
            document.getElementById('movimento-form').reset();
            document.getElementById('data').valueAsDate = new Date();
            document.getElementById('form-submit-text').textContent = 'Aggiungi Movimento';
            document.getElementById('cancel-edit').style.display = 'none';
            app.editingId = null;
        }

        async function toggleEseguito(id) {
            const movimento = app.movimenti.find(m => m.id === id);
            if (!movimento) return;
            
            try {
                const nuovoStato = movimento.stato === 'eseguito' ? 'previsto' : 'eseguito';
                await updateMovimento(id, { stato: nuovoStato });
                console.log(`Movimento ${nuovoStato}`);
            } catch (error) {
                console.error('Errore aggiornamento stato:', error);
                alert('Errore durante l\'aggiornamento dello stato');
            }
        }

        async function toggleBloccato(id) {
            const movimento = app.movimenti.find(m => m.id === id);
            if (!movimento) return;
            
            try {
                const nuovoStato = movimento.is_modificato ? false : true;
                await updateMovimento(id, { is_modificato: nuovoStato });
                console.log(`Movimento ${nuovoStato ? 'bloccato' : 'sbloccato'}`);
            } catch (error) {
                console.error('Errore toggle blocco:', error);
                alert('Errore durante il blocco/sblocco del movimento');
            }
        }

        async function duplicateMovimentoAction(id) {
            const movimento = app.movimenti.find(m => m.id === id);
            if (!movimento) return;
            
            try {
                await duplicateMovimento(movimento);
                console.log('Movimento duplicato con successo');
            } catch (error) {
                console.error('Errore duplicazione:', error);
                alert('Errore durante la duplicazione del movimento');
            }
        }

        function confirmDelete(id) {
            const movimento = app.movimenti.find(m => m.id === id);
            if (!movimento) return;
            
            // Controlla se il movimento √® bloccato
            if (movimento.is_modificato) {
                alert('‚ö†Ô∏è Movimento bloccato. Sblocca prima di eliminare.');
                return;
            }
            
            showModal(
                'Elimina Movimento',
                'Sei sicuro di voler eliminare questo movimento? L\'operazione non pu√≤ essere annullata.',
                async () => {
                    try {
                        await deleteMovimento(id);
                        console.log('Movimento eliminato con successo');
                    } catch (error) {
                        console.error('Errore eliminazione:', error);
                        alert('Errore durante l\'eliminazione del movimento');
                    }
                }
            );
        }

        async function duplicateMovimentoAction(id) {
            const movimento = app.movimenti.find(m => m.id === id);
            if (!movimento) return;
            
            try {
                await duplicateMovimento(movimento);
                console.log('Movimento duplicato con successo');
            } catch (error) {
                console.error('Errore duplicazione:', error);
                alert('Errore durante la duplicazione del movimento');
            }
        }

        function confirmDelete(id) {
            const movimento = app.movimenti.find(m => m.id === id);
            if (!movimento) return;
            
            // Controlla se il movimento √® bloccato
            if (movimento.is_modificato) {
                alert('‚ö†Ô∏è Movimento bloccato. Sblocca prima di eliminare.');
                return;
            }
            
            showModal(
                'Elimina Movimento',
                'Sei sicuro di voler eliminare questo movimento? L\'operazione non pu√≤ essere annullata.',
                async () => {
                    try {
                        await deleteMovimento(id);
                        console.log('Movimento eliminato con successo');
                    } catch (error) {
                        console.error('Errore eliminazione:', error);
                        alert('Errore durante l\'eliminazione del movimento');
                    }
                }
            );
        }

        // === MODAL FUNCTIONS ===
        function showModal(title, message, onConfirm) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal-overlay').style.display = 'flex';
            
            document.getElementById('modal-confirm').onclick = () => {
                hideModal();
                onConfirm();
            };
        }

        function hideModal() {
            document.getElementById('modal-overlay').style.display = 'none';
        }

        // === DRAG & DROP ===
        function initDragDrop() {
            // Implementazione drag & drop sar√† aggiunta nella prossima iterazione
            console.log('Drag & Drop non ancora implementato');
        }

        // === EVENT LISTENERS ===
        function setupEventListeners() {
            console.log('üéØ Inizializzando event listeners...');
            
            // Form movimento
            document.getElementById('movimento-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                
                // Previeni doppio submit
                const submitBtn = e.target.querySelector('button[type="submit"]');
                if (submitBtn.disabled) return;
                
                submitBtn.disabled = true;
                submitBtn.style.opacity = '0.6';
                
                const formData = {
                    data: document.getElementById('data').value,
                    descrizione: document.getElementById('descrizione').value.trim(),
                    importo: parseFloat(document.getElementById('importo').value),
                    categoria_id: document.getElementById('categoria').value,
                    tipo: document.getElementById('tipo').value,
                    stato: document.getElementById('stato').value,
                    posizione_ordinamento: 0
                };
                
                console.log('üìù Submitting form data:', formData);
                
                try {
                    if (app.editingId) {
                        await updateMovimento(app.editingId, formData);
                        console.log('‚úÖ Movimento aggiornato');
                    } else {
                        await saveMovimento(formData);
                        console.log('‚úÖ Movimento aggiunto');
                    }
                    resetForm();
                } catch (error) {
                    console.error('‚ùå Errore salvataggio movimento:', error);
                    alert('Errore durante il salvataggio del movimento');
                } finally {
                    // Riabilita il pulsante
                    submitBtn.disabled = false;
                    submitBtn.style.opacity = '1';
                }
            });
            
            // Annulla modifica
            document.getElementById('cancel-edit').addEventListener('click', resetForm);
            
            // Salva impostazioni
            document.getElementById('salva-impostazioni').addEventListener('click', async () => {
                const btn = document.getElementById('salva-impostazioni');
                if (btn.disabled) return;
                
                btn.disabled = true;
                btn.style.opacity = '0.6';
                
                try {
                    await saveSettings();
                    alert('Impostazioni salvate con successo');
                } catch (error) {
                    console.error('Errore salvataggio impostazioni:', error);
                    alert('Errore durante il salvataggio delle impostazioni');
                } finally {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                }
            });
            
            // Modal
            document.getElementById('modal-close').addEventListener('click', hideModal);
            document.getElementById('modal-cancel').addEventListener('click', hideModal);
            document.getElementById('modal-overlay').addEventListener('click', (e) => {
                if (e.target === e.currentTarget) hideModal();
            });
            
            // Filtro categorie per tipo
            document.getElementById('tipo').addEventListener('change', (e) => {
                const categoriaSelect = document.getElementById('categoria');
                categoriaSelect.value = ''; // Reset selezione categoria
            });
            
            console.log('‚úÖ Event listeners inizializzati');
        }
        
        // Inizializza icone Lucide quando la pagina √® pronta
        document.addEventListener('DOMContentLoaded', () => {
            init();
            
            // Inizializza le icone dopo un breve delay
            setTimeout(() => {
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }, 100);
        });
    </script>
</body>
</html>
