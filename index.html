<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Cassa</title>
    <style>
        /* Evidenziazione movimenti modificati */
        .movimento-modificato {
            background-color: rgba(99, 102, 241, 0.05) !important;
            border-left: 3px solid var(--primary);
        }
        
        .movimento-modificato:hover {
            background-color: rgba(99, 102, 241, 0.08) !important;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header con saldi -->
        <header class="app-header">
            <h1 class="header-title">Gestione Cassa</h1>
            <div class="saldi-container">
                <div class="saldo-card">
                    <div class="saldo-label">Saldo Contabile</div>
                    <div class="saldo-value" id="saldo-contabile">€ 0,00</div>
                </div>
                <div class="saldo-card">
                    <div class="saldo-label">Saldo Disponibile</div>
                    <div class="saldo-value" id="saldo-disponibile">€ 0,00</div>
                </div>
            </div>
        </header>

        <!-- Sidebar con menu -->
        <aside class="app-sidebar">
            <div class="sidebar-menu">
                <div class="menu-item active" id="menu-movimenti">
                    <i data-lucide="credit-card" class="menu-icon"></i>
                    <span>Movimenti</span>
                </div>
                <div class="menu-item" id="menu-storico">
                    <i data-lucide="archive" class="menu-icon"></i>
                    <span>Storico</span>
                </div>
            </div>
            
            <!-- Impostazioni veloci -->
            <div class="card" style="margin-top: 2rem;">
                <div class="card-header">
                    <h2 class="card-title">Impostazioni</h2>
                </div>
                <div class="card-content">
                    <div class="form-group">
                        <label class="form-label" for="saldo-iniziale-quick">Saldo Iniziale (€)</label>
                        <input type="number" id="saldo-iniziale-quick" class="form-input" 
                               step="0.01" placeholder="0,00">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="limite-scoperto-quick">Limite Scoperto (€)</label>
                        <input type="number" id="limite-scoperto-quick" class="form-input" 
                               step="0.01" min="0" placeholder="0,00">
                    </div>
                    
                    <button type="button" id="salva-impostazioni-quick" class="btn btn-secondary" 
                            style="width: 100%;">
                        <i data-lucide="save" style="width: 16px; height: 16px;"></i>
                        Salva
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main content -->
        <main class="app-main">
            <div class="main-header">
                <h2 id="main-title">Movimenti Attivi</h2>
                <div class="main-actions">
                    <button class="btn btn-primary" id="add-movimento-btn">
                        <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
                        Nuovo Movimento
                    </button>
                    <button class="btn btn-success" id="storicizza-btn">
                        <i data-lucide="archive" style="width: 16px; height: 16px;"></i>
                        Storicizza Eseguiti
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-content" style="padding: 0;">
                    <div class="table-container">
                        <table class="movimenti-table">
                            <thead>
                                <tr>
                                    <th style="width: 40px;">⋮⋮</th>
                                    <th>Data</th>
                                    <th>Descrizione</th>
                                    <th>Categoria</th>
                                    <th>Importo</th>
                                    <th>Tipo</th>
                                    <th>Stato</th>
                                    <th>Saldo Contabile</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="movimenti-tbody">
                                <!-- Movimenti generati dinamicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal per movimento -->
    <div id="movimento-modal" class="modal-overlay" style="display: none;">
        <div class="modal large">
            <div class="modal-header">
                <h3 class="modal-title" id="movimento-modal-title">Nuovo Movimento</h3>
                <button class="modal-close" id="movimento-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="movimento-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="data">Data *</label>
                            <input type="date" id="data" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="stato">Stato</label>
                            <select id="stato" class="form-select" required>
                                <option value="previsto">Previsto</option>
                                <option value="eseguito">Eseguito</option>
                                <option value="annullato">Annullato</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="descrizione">Descrizione *</label>
                        <input type="text" id="descrizione" class="form-input" required 
                               placeholder="Es: Pagamento fornitore ABC">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="tipo">Tipo *</label>
                            <select id="tipo" class="form-select" required>
                                <option value="">Seleziona tipo</option>
                                <option value="entrata">Entrata</option>
                                <option value="uscita">Uscita</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="importo">Importo (€) *</label>
                            <input type="number" id="importo" class="form-input" 
                                   step="0.01" min="0.01" required placeholder="0,00">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="categoria">Categoria *</label>
                        <select id="categoria" class="form-select" required>
                            <option value="">Seleziona categoria</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="movimento-modal-cancel">
                    <i data-lucide="x" style="width: 16px; height: 16px;"></i>
                    Annulla
                </button>
                <button type="submit" form="movimento-form" class="btn btn-primary" id="movimento-modal-save">
                    <i data-lucide="save" style="width: 16px; height: 16px;"></i>
                    <span id="movimento-save-text">Salva Movimento</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal per conferme -->
    <div id="modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Conferma</h3>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p id="modal-message">Sei sicuro?</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="modal-cancel">Annulla</button>
                <button class="btn btn-danger" id="modal-confirm">Conferma</button>
            </div>
        </div>
    </div>

    <script src="config.js"></script>
    <script>
        // Configurazione
        window.SUPABASE_CONFIG = window.SUPABASE_CONFIG || SUPABASE_CONFIG || {
            url: 'https://pnrjsisykqzwvcdjdyri.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBucmpzaXN5a3F6d3ZjZGpkeXJpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MDM5MzAsImV4cCI6MjA3NDM3OTkzMH0.vpauNA2NYZlA9vIW7SItUvM3GuOxLAvFLdUQehNCQ-0'
        };
        
        window.CONFIG_UTILS = window.CONFIG_UTILS || CONFIG_UTILS || {
            formatCurrency: (amount) => {
                return new Intl.NumberFormat('it-IT', {
                    style: 'currency',
                    currency: 'EUR',
                    minimumFractionDigits: 2
                }).format(amount);
            },
            formatDate: (date) => {
                return new Date(date).toLocaleDateString('it-IT');
            }
        };

        // Stato globale
        const app = {
            movimenti: [],
            movimentiStorico: [],
            categorie: [],
            settings: { saldoIniziale: 0, limiteScoperto: 0 },
            saldoContabile: 0,
            saldoDisponibile: 0,
            editingId: null,
            initialized: false,
            currentView: 'movimenti',
            // Stato drag & drop
            draggedElement: null,
            draggedId: null,
            dropTarget: null,
            dropPosition: null
        };

        let supabaseClient;

        // === DRAG & DROP SYSTEM ===
        function initializeDragAndDrop() {
            const tbody = document.getElementById('movimenti-tbody');
            if (!tbody) return;

            // Aggiungi event listeners per il drag & drop
            tbody.addEventListener('dragstart', handleDragStart, false);
            tbody.addEventListener('dragenter', handleDragEnter, false);
            tbody.addEventListener('dragover', handleDragOver, false);
            tbody.addEventListener('dragleave', handleDragLeave, false);
            tbody.addEventListener('drop', handleDrop, false);
            tbody.addEventListener('dragend', handleDragEnd, false);
        }

        function handleDragStart(e) {
            console.log('🔥 DRAG START EVENT:', e.target);
            if (!e.target.closest('.movimento-row')) return;
            
            const row = e.target.closest('.movimento-row');
            app.draggedElement = row;
            app.draggedId = row.dataset.id;
            
            row.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', row.outerHTML);
            
            console.log('🎯 Drag started for movement:', app.draggedId);
        }

        function handleDragEnter(e) {
            e.preventDefault();
            if (!app.draggedElement) return;
            
            const row = e.target.closest('.movimento-row');
            if (!row || row === app.draggedElement) return;
            
            clearDropIndicators();
            
            const rect = row.getBoundingClientRect();
            const midpoint = rect.top + rect.height / 2;
            const mouseY = e.clientY;
            
            if (mouseY < midpoint) {
                row.classList.add('drag-over-before');
                app.dropPosition = 'before';
            } else {
                row.classList.add('drag-over-after');
                app.dropPosition = 'after';
            }
            
            app.dropTarget = row;
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDragLeave(e) {
            // Solo se usciamo completamente dalla riga
            const row = e.target.closest('.movimento-row');
            if (!row) return;
            
            const rect = row.getBoundingClientRect();
            const x = e.clientX;
            const y = e.clientY;
            
            if (x < rect.left || x > rect.right || y < rect.top || y > rect.bottom) {
                clearDropIndicators();
            }
        }

        async function handleDrop(e) {
            e.preventDefault();
            if (!app.draggedElement || !app.dropTarget) return;
            
            const draggedId = app.draggedId;
            const targetId = app.dropTarget.dataset.id;
            const position = app.dropPosition;
            
            console.log('📍 Drop:', { draggedId, targetId, position });
            
            try {
                await repositionMovimento(draggedId, targetId, position);
                console.log('✅ Riposizionamento completato');
            } catch (error) {
                console.error('❌ Errore riposizionamento:', error);
                alert('Errore durante il riordino: ' + error.message);
            }
            
            clearDropIndicators();
        }

        function handleDragEnd(e) {
            if (app.draggedElement) {
                app.draggedElement.classList.remove('dragging');
            }
            
            clearDropIndicators();
            app.draggedElement = null;
            app.draggedId = null;
            app.dropTarget = null;
            app.dropPosition = null;
        }

        function clearDropIndicators() {
            const rows = document.querySelectorAll('.movimento-row');
            rows.forEach(row => {
                row.classList.remove('drag-over-before', 'drag-over-after');
            });
        }

        async function repositionMovimento(draggedId, targetId, position) {
            const draggedMovimento = app.movimenti.find(m => m.id === draggedId);
            const targetMovimento = app.movimenti.find(m => m.id === targetId);
            
            if (!draggedMovimento || !targetMovimento) {
                throw new Error('Movimento non trovato');
            }
            
            console.log('🔄 Riposizionamento:', {
                dragged: draggedMovimento.descrizione,
                target: targetMovimento.descrizione,
                position
            });
            
            // Calcola nuovo ordinamento per posizionamento relativo
            const movimentiOrdinati = [...app.movimenti].sort((a, b) => {
                const dateCompare = new Date(a.data) - new Date(b.data);
                if (dateCompare !== 0) return dateCompare;
                return (a.posizione_ordinamento || 0) - (b.posizione_ordinamento || 0);
            });
            
            const targetIndex = movimentiOrdinati.findIndex(m => m.id === targetId);
            let nuovoOrdinamento;
            
            if (position === 'before') {
                // Inserisce PRIMA del target
                if (targetIndex > 0) {
                    const precedente = movimentiOrdinati[targetIndex - 1];
                    nuovoOrdinamento = (precedente.posizione_ordinamento || 0) + 0.5;
                } else {
                    nuovoOrdinamento = (targetMovimento.posizione_ordinamento || 0) - 1;
                }
            } else {
                // Inserisce DOPO il target
                if (targetIndex < movimentiOrdinati.length - 1) {
                    const successivo = movimentiOrdinati[targetIndex + 1];
                    nuovoOrdinamento = ((targetMovimento.posizione_ordinamento || 0) + (successivo.posizione_ordinamento || 0)) / 2;
                } else {
                    nuovoOrdinamento = (targetMovimento.posizione_ordinamento || 0) + 1;
                }
            }
            
            // Aggiorna SOLO il movimento trascinato
            const updates = {
                posizione_ordinamento: nuovoOrdinamento,
                is_modificato: true,
                updated_at: new Date().toISOString()
            };
            
            await updateMovimento(draggedId, updates);
            
            console.log('✅ Movimento riposizionato:', {
                id: draggedId,
                nuovoOrdinamento: nuovoOrdinamento
            });
        }

        function findPreviousAvailableDate(targetDate) {
            // Cerca una data libera prima del target
            const existingDates = app.movimenti.map(m => m.data).sort();
            let checkDate = new Date(targetDate);
            checkDate.setDate(checkDate.getDate() - 1);
            
            // Vai indietro fino a trovare una data libera
            while (existingDates.includes(checkDate.toISOString().split('T')[0])) {
                checkDate.setDate(checkDate.getDate() - 1);
            }
            
            return checkDate;
        }

        function findNextAvailableDate(targetDate) {
            // Cerca una data libera dopo il target
            const existingDates = app.movimenti.map(m => m.data).sort();
            let checkDate = new Date(targetDate);
            checkDate.setDate(checkDate.getDate() + 1);
            
            // Vai avanti fino a trovare una data libera
            while (existingDates.includes(checkDate.toISOString().split('T')[0])) {
                checkDate.setDate(checkDate.getDate() + 1);
            }
            
            return checkDate;
        }

        // Funzioni database
        async function loadCategorie() {
            const { data, error } = await supabaseClient
                .from('categorie')
                .select('*')
                .eq('attiva', true)
                .order('tipo', { ascending: true });
            
            if (error) throw error;
            app.categorie = data || [];
            updateCategorieSelect();
        }

        async function loadSettings() {
            const { data, error } = await supabaseClient
                .from('settings')
                .select('*')
                .limit(1);
            
            if (error) throw error;
            
            if (data && data.length > 0) {
                app.settings = {
                    saldoIniziale: parseFloat(data[0].saldo_iniziale) || 0,
                    limiteScoperto: parseFloat(data[0].limite_scoperto) || 0
                };
            }
            updateSettingsForm();
        }

        async function loadMovimenti() {
            const { data, error } = await supabaseClient
                .from('movimenti')
                .select(`*, categoria:categorie(nome, colore)`)
                .eq('storicizzato', false)
                .order('data', { ascending: true })
                .order('posizione_ordinamento', { ascending: true });
            
            if (error) {
                if (error.message.includes('storicizzato') || error.message.includes('posizione_ordinamento')) {
                    const { data: allData, error: fallbackError } = await supabaseClient
                        .from('movimenti')
                        .select(`*, categoria:categorie(nome, colore)`)
                        .neq('stato', 'annullato')
                        .order('data', { ascending: true });
                    
                    if (fallbackError) throw fallbackError;
                    app.movimenti = allData || [];
                } else {
                    throw error;
                }
            } else {
                app.movimenti = data || [];
            }
            
            if (app.currentView === 'movimenti') {
                renderTabella();
            }
            updateSaldi();
        }

        async function loadMovimentiStorico() {
            const { data, error } = await supabaseClient
                .from('movimenti')
                .select(`*, categoria:categorie(nome, colore)`)
                .eq('storicizzato', true)
                .order('storicizzato_at', { ascending: false });
            
            if (error) {
                if (error.message.includes('storicizzato')) {
                    const { data: allData, error: fallbackError } = await supabaseClient
                        .from('movimenti')
                        .select(`*, categoria:categorie(nome, colore)`)
                        .eq('stato', 'annullato')
                        .order('updated_at', { ascending: false });
                    
                    if (fallbackError) throw fallbackError;
                    app.movimentiStorico = allData || [];
                } else {
                    throw error;
                }
            } else {
                app.movimentiStorico = data || [];
            }
            
            renderTabellaStorico();
        }

        async function saveMovimento(movimento) {
            // Aggiungi ordinamento automatico per nuovi movimenti
            const maxOrdinamento = Math.max(...app.movimenti.map(m => m.posizione_ordinamento || 0));
            movimento.posizione_ordinamento = maxOrdinamento + 1;
            
            const { data, error } = await supabaseClient
                .from('movimenti')
                .insert([movimento])
                .select();
            
            if (error && error.message.includes('posizione_ordinamento')) {
                // Fallback per DB senza colonna posizione_ordinamento
                delete movimento.posizione_ordinamento;
                const { data: fallbackData, error: fallbackError } = await supabaseClient
                    .from('movimenti')
                    .insert([movimento])
                    .select();
                
                if (fallbackError) throw fallbackError;
                await loadMovimenti();
                return fallbackData[0];
            }
            
            if (error) throw error;
            await loadMovimenti();
            return data[0];
        }

        async function updateMovimento(id, updates) {
            const { data, error } = await supabaseClient
                .from('movimenti')
                .update(updates)
                .eq('id', id)
                .select();
            
            if (error && error.message.includes('posizione_ordinamento')) {
                // Fallback per DB senza colonna posizione_ordinamento
                delete updates.posizione_ordinamento;
                const { data: fallbackData, error: fallbackError } = await supabaseClient
                    .from('movimenti')
                    .update(updates)
                    .eq('id', id)
                    .select();
                
                if (fallbackError) throw fallbackError;
                await loadMovimenti();
                return fallbackData[0];
            }
            
            if (error) throw error;
            await loadMovimenti();
            return data[0];
        }

        async function deleteMovimento(id) {
            const { error } = await supabaseClient
                .from('movimenti')
                .delete()
                .eq('id', id);
            
            if (error) throw error;
            await loadMovimenti();
        }

        async function saveSettings() {
            const settings = {
                saldo_iniziale: parseFloat(document.getElementById('saldo-iniziale-quick').value) || 0,
                limite_scoperto: parseFloat(document.getElementById('limite-scoperto-quick').value) || 0,
                updated_at: new Date().toISOString()
            };

            const { error } = await supabaseClient
                .from('settings')
                .upsert(settings);
            
            if (error) throw error;
            
            app.settings.saldoIniziale = settings.saldo_iniziale;
            app.settings.limiteScoperto = settings.limite_scoperto;
            updateSaldi();
        }

        // Funzioni UI
        function updateCategorieSelect() {
            const select = document.getElementById('categoria');
            if (!select) return;
            
            const currentValue = select.value;
            const firstOption = select.children[0];
            select.innerHTML = '';
            if (firstOption) select.appendChild(firstOption);
            
            ['entrata', 'uscita'].forEach(tipo => {
                const categorieTipo = app.categorie.filter(c => c.tipo === tipo);
                if (categorieTipo.length > 0) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = tipo.charAt(0).toUpperCase() + tipo.slice(1) + 'e';
                    
                    categorieTipo.forEach(categoria => {
                        const option = document.createElement('option');
                        option.value = categoria.id;
                        option.textContent = categoria.nome;
                        optgroup.appendChild(option);
                    });
                    
                    select.appendChild(optgroup);
                }
            });
            
            if (currentValue) select.value = currentValue;
        }

        function updateSettingsForm() {
            const saldoEl = document.getElementById('saldo-iniziale-quick');
            const scopertorEl = document.getElementById('limite-scoperto-quick');
            
            if (saldoEl) saldoEl.value = app.settings.saldoIniziale;
            if (scopertorEl) scopertorEl.value = app.settings.limiteScoperto;
        }

        function updateSaldi() {
            const movimentiValidi = app.movimenti.filter(m => m.stato !== 'annullato');
            
            const entrate = movimentiValidi
                .filter(m => m.tipo === 'entrata')
                .reduce((sum, m) => sum + Math.abs(parseFloat(m.importo)), 0);
            
            const uscite = movimentiValidi
                .filter(m => m.tipo === 'uscita')
                .reduce((sum, m) => sum + Math.abs(parseFloat(m.importo)), 0);
            
            app.saldoContabile = app.settings.saldoIniziale + entrate - uscite;
            app.saldoDisponibile = app.saldoContabile - app.settings.limiteScoperto;
            
            const saldoContabileEl = document.getElementById('saldo-contabile');
            const saldoDisponibileEl = document.getElementById('saldo-disponibile');
            
            if (saldoContabileEl) saldoContabileEl.textContent = window.CONFIG_UTILS.formatCurrency(app.saldoContabile);
            if (saldoDisponibileEl) saldoDisponibileEl.textContent = window.CONFIG_UTILS.formatCurrency(app.saldoDisponibile);
        }

        function renderTabella() {
            const tbody = document.getElementById('movimenti-tbody');
            if (!tbody) return;
            
            if (app.movimenti.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 3rem; color: var(--gray-500);">
                            Nessun movimento presente. Clicca "Nuovo Movimento" per iniziare.
                        </td>
                    </tr>
                `;
                return;
            }
            
            let saldoProgressivo = app.settings.saldoIniziale;
            
            const movimentiConSaldo = [...app.movimenti]
                .sort((a, b) => {
                    // Prima per data, poi per ordinamento custom
                    const dateCompare = new Date(a.data) - new Date(b.data);
                    if (dateCompare !== 0) return dateCompare;
                    return (a.posizione_ordinamento || 0) - (b.posizione_ordinamento || 0);
                })
                .map(movimento => {
                    if (movimento.stato !== 'annullato') {
                        if (movimento.tipo === 'entrata') {
                            saldoProgressivo += Math.abs(parseFloat(movimento.importo));
                        } else {
                            saldoProgressivo -= Math.abs(parseFloat(movimento.importo));
                        }
                    }
                    
                    let saldoClass = 'saldo-positivo';
                    let saldoIcon = 'check-circle';
                    
                    if (saldoProgressivo < 0) {
                        if (saldoProgressivo > -app.settings.limiteScoperto) {
                            saldoClass = 'saldo-allerta';
                            saldoIcon = 'alert-triangle';
                        } else {
                            saldoClass = 'saldo-critico';
                            saldoIcon = 'x-circle';
                        }
                    }
                    
                    return { ...movimento, saldoProgressivo, saldoClass, saldoIcon };
                });
            
            tbody.innerHTML = movimentiConSaldo.map(movimento => `
                <tr class="movimento-row ${movimento.is_modificato ? 'movimento-modificato' : ''}" data-id="${movimento.id}" draggable="true">
                    <td class="drag-handle" style="text-align: center; color: var(--gray-400); cursor: move; user-select: none; font-weight: bold;">
                        ⋮⋮
                    </td>
                    <td>${window.CONFIG_UTILS.formatDate(movimento.data)}</td>
                    <td>
                        ${movimento.descrizione}
                        ${movimento.is_modificato ? '<span style="color: var(--primary); font-size: 0.75em; margin-left: 4px;">●</span>' : ''}
                    </td>
                    <td>
                        <span class="categoria-badge" style="background-color: ${movimento.categoria?.colore || '#e5e7eb'}20;">
                            ${movimento.categoria?.nome || 'N/A'}
                        </span>
                    </td>
                    <td class="${movimento.tipo === 'entrata' ? 'tipo-entrata' : 'tipo-uscita'}">
                        ${movimento.tipo === 'entrata' ? '+' : '−'}${window.CONFIG_UTILS.formatCurrency(Math.abs(movimento.importo))}
                    </td>
                    <td class="${movimento.tipo === 'entrata' ? 'tipo-entrata' : 'tipo-uscita'}">
                        ${movimento.tipo.charAt(0).toUpperCase() + movimento.tipo.slice(1)}
                    </td>
                    <td>
                        <span class="status-badge status-${movimento.stato}">
                            ${movimento.stato}
                        </span>
                    </td>
                    <td class="saldo-progressivo ${movimento.saldoClass}">
                        <div class="saldo-container">
                            <i data-lucide="${movimento.saldoIcon}" class="saldo-icon"></i>
                            <span class="saldo-amount">${window.CONFIG_UTILS.formatCurrency(movimento.saldoProgressivo)}</span>
                        </div>
                    </td>
                    <td class="actions-cell">
                        <div class="action-buttons">
                            <button class="btn-icon ${movimento.stato === 'eseguito' ? 'executed' : 'pending'}" 
                                    onclick="toggleEseguito('${movimento.id}')">
                                <i data-lucide="${movimento.stato === 'eseguito' ? 'check-circle-2' : 'circle'}"></i>
                            </button>
                            <button class="btn-icon edit" onclick="editMovimento('${movimento.id}')">
                                <i data-lucide="edit"></i>
                            </button>
                            <button class="btn-icon duplicate" onclick="duplicateMovimento('${movimento.id}')">
                                <i data-lucide="copy"></i>
                            </button>
                            <button class="btn-icon delete" onclick="confirmDelete('${movimento.id}')">
                                <i data-lucide="trash-2"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            lucide.createIcons();
            initializeDragAndDrop();
        }

        function renderTabellaStorico() {
            const tbody = document.getElementById('movimenti-tbody');
            if (!tbody) return;
            
            if (app.movimentiStorico.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 3rem; color: var(--gray-500);">
                            Nessun movimento nello storico.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = app.movimentiStorico.map(movimento => `
                <tr class="movimento-row storico-row" data-id="${movimento.id}">
                    <td style="text-align: center; color: var(--gray-300); user-select: none; font-weight: bold;">
                        ◦◦
                    </td>
                    <td>${window.CONFIG_UTILS.formatDate(movimento.data)}</td>
                    <td>${movimento.descrizione}</td>
                    <td>
                        <span class="categoria-badge" style="background-color: ${movimento.categoria?.colore || '#e5e7eb'}20;">
                            ${movimento.categoria?.nome || 'N/A'}
                        </span>
                    </td>
                    <td class="${movimento.tipo === 'entrata' ? 'tipo-entrata' : 'tipo-uscita'}">
                        ${movimento.tipo === 'entrata' ? '+' : '−'}${window.CONFIG_UTILS.formatCurrency(Math.abs(movimento.importo))}
                    </td>
                    <td class="${movimento.tipo === 'entrata' ? 'tipo-entrata' : 'tipo-uscita'}">
                        ${movimento.tipo.charAt(0).toUpperCase() + movimento.tipo.slice(1)}
                    </td>
                    <td>
                        <span class="status-badge status-eseguito">Storicizzato</span>
                    </td>
                    <td class="saldo-progressivo">
                        <div class="saldo-container">
                            <i data-lucide="archive" class="saldo-icon" style="color: var(--gray-400);"></i>
                            <span class="saldo-amount" style="color: var(--gray-500);">Archiviato</span>
                        </div>
                    </td>
                    <td class="actions-cell">
                        <div class="action-buttons">
                            <button class="btn-icon restore" onclick="ripristinaMovimento('${movimento.id}')" title="Ripristina">
                                <i data-lucide="undo-2"></i>
                            </button>
                            <button class="btn-icon delete" onclick="eliminaDefinitivamente('${movimento.id}')" title="Elimina definitivamente">
                                <i data-lucide="trash-2"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            lucide.createIcons();
        }

        // Navigazione
        function switchToMovimenti() {
            app.currentView = 'movimenti';
            document.getElementById('main-title').textContent = 'Movimenti Attivi';
            document.getElementById('menu-movimenti').classList.add('active');
            document.getElementById('menu-storico').classList.remove('active');
            document.getElementById('add-movimento-btn').style.display = 'inline-flex';
            document.getElementById('storicizza-btn').style.display = 'inline-flex';
            renderTabella();
        }

        function switchToStorico() {
            app.currentView = 'storico';
            document.getElementById('main-title').textContent = 'Storico Movimenti';
            document.getElementById('menu-storico').classList.add('active');
            document.getElementById('menu-movimenti').classList.remove('active');
            document.getElementById('add-movimento-btn').style.display = 'none';
            document.getElementById('storicizza-btn').style.display = 'none';
            loadMovimentiStorico();
        }

        // Modal
        function showMovimentoModal(movimento = null) {
            const modal = document.getElementById('movimento-modal');
            if (!modal) return;
            
            if (movimento) {
                document.getElementById('movimento-modal-title').textContent = 'Modifica Movimento';
                document.getElementById('movimento-save-text').textContent = 'Aggiorna';
                document.getElementById('data').value = movimento.data;
                document.getElementById('descrizione').value = movimento.descrizione;
                document.getElementById('importo').value = Math.abs(movimento.importo);
                document.getElementById('tipo').value = movimento.tipo;
                document.getElementById('categoria').value = movimento.categoria_id;
                document.getElementById('stato').value = movimento.stato;
                app.editingId = movimento.id;
            } else {
                document.getElementById('movimento-modal-title').textContent = 'Nuovo Movimento';
                document.getElementById('movimento-save-text').textContent = 'Salva';
                document.getElementById('movimento-form').reset();
                document.getElementById('data').valueAsDate = new Date();
                app.editingId = null;
            }
            
            updateCategorieSelect();
            modal.style.display = 'flex';
        }

        function hideMovimentoModal() {
            const modal = document.getElementById('movimento-modal');
            if (modal) modal.style.display = 'none';
        }

        function showConfirmModal(title, message, onConfirm) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal-overlay').style.display = 'flex';
            document.getElementById('modal-confirm').onclick = () => {
                document.getElementById('modal-overlay').style.display = 'none';
                onConfirm();
            };
        }

        // Azioni movimenti
        async function toggleEseguito(id) {
            const movimento = app.movimenti.find(m => m.id === id);
            if (!movimento) return;
            const nuovoStato = movimento.stato === 'eseguito' ? 'previsto' : 'eseguito';
            await updateMovimento(id, { stato: nuovoStato });
        }

        function editMovimento(id) {
            const movimento = app.movimenti.find(m => m.id === id);
            if (movimento) showMovimentoModal(movimento);
        }

        async function duplicateMovimento(id) {
            const movimento = app.movimenti.find(m => m.id === id);
            if (!movimento) return;
            
            const duplicato = {
                data: movimento.data,
                descrizione: movimento.descrizione + ' (copia)',
                importo: movimento.importo,
                categoria_id: movimento.categoria_id,
                tipo: movimento.tipo,
                stato: 'previsto'
            };
            
            await saveMovimento(duplicato);
        }

        function confirmDelete(id) {
            showConfirmModal(
                'Elimina Movimento',
                'Sei sicuro di voler eliminare questo movimento?',
                () => deleteMovimento(id)
            );
        }

        async function storicizzaEseguiti() {
            const eseguiti = app.movimenti.filter(m => m.stato === 'eseguito');
            if (eseguiti.length === 0) {
                alert('Nessun movimento eseguito da storicizzare');
                return;
            }
            
            showConfirmModal(
                'Storicizza Movimenti',
                `Vuoi spostare ${eseguiti.length} movimenti nello storico?`,
                async () => {
                    const ids = eseguiti.map(m => m.id);
                    
                    const { error } = await supabaseClient
                        .from('movimenti')
                        .update({ 
                            storicizzato: true, 
                            storicizzato_at: new Date().toISOString() 
                        })
                        .in('id', ids);
                    
                    if (error && error.message.includes('storicizzato')) {
                        for (const movimento of eseguiti) {
                            await supabaseClient
                                .from('movimenti')
                                .update({ 
                                    descrizione: `[STORICIZZATO] ${movimento.descrizione}`,
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', movimento.id);
                        }
                        alert(`${ids.length} movimenti spostati nello storico (modalità compatibilità)`);
                    } else if (error) {
                        console.error('Errore:', error);
                        alert('Errore durante la storicizzazione');
                    } else {
                        alert(`${ids.length} movimenti spostati nello storico`);
                    }
                    
                    await loadMovimenti();
                }
            );
        }

        async function ripristinaMovimento(id) {
            const { error } = await supabaseClient
                .from('movimenti')
                .update({ 
                    storicizzato: false, 
                    storicizzato_at: null,
                    stato: 'eseguito'
                })
                .eq('id', id);
            
            if (error && error.message.includes('storicizzato')) {
                await supabaseClient
                    .from('movimenti')
                    .update({ stato: 'eseguito' })
                    .eq('id', id);
            }
            
            await loadMovimentiStorico();
            await loadMovimenti();
            alert('Movimento ripristinato');
        }

        function eliminaDefinitivamente(id) {
            showConfirmModal(
                'Elimina Definitivamente',
                'Sei sicuro? Questa operazione non può essere annullata.',
                async () => {
                    await deleteMovimento(id);
                    await loadMovimentiStorico();
                    alert('Movimento eliminato definitivamente');
                }
            );
        }

        // Inizializzazione
        async function initApp() {
            if (app.initialized) return;
            app.initialized = true;
            
            try {
                const { createClient } = supabase;
                supabaseClient = createClient(window.SUPABASE_CONFIG.url, window.SUPABASE_CONFIG.key);
                
                await loadCategorie();
                await loadSettings(); 
                await loadMovimenti();
                
                // Event listeners
                document.getElementById('add-movimento-btn').addEventListener('click', () => showMovimentoModal());
                document.getElementById('storicizza-btn').addEventListener('click', storicizzaEseguiti);
                document.getElementById('salva-impostazioni-quick').addEventListener('click', saveSettings);
                document.getElementById('menu-movimenti').addEventListener('click', switchToMovimenti);
                document.getElementById('menu-storico').addEventListener('click', switchToStorico);
                
                // Modal listeners
                document.getElementById('movimento-modal-close').addEventListener('click', hideMovimentoModal);
                document.getElementById('movimento-modal-cancel').addEventListener('click', hideMovimentoModal);
                document.getElementById('modal-close').addEventListener('click', () => document.getElementById('modal-overlay').style.display = 'none');
                document.getElementById('modal-cancel').addEventListener('click', () => document.getElementById('modal-overlay').style.display = 'none');
                
                // Form submit
                document.getElementById('movimento-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const formData = {
                        data: document.getElementById('data').value,
                        descrizione: document.getElementById('descrizione').value,
                        importo: parseFloat(document.getElementById('importo').value),
                        categoria_id: document.getElementById('categoria').value,
                        tipo: document.getElementById('tipo').value,
                        stato: document.getElementById('stato').value
                    };
                    
                    if (app.editingId) {
                        await updateMovimento(app.editingId, formData);
                    } else {
                        await saveMovimento(formData);
                    }
                    
                    hideMovimentoModal();
                });
                
                lucide.createIcons();
                console.log('App inizializzata con Drag & Drop');
                
            } catch (error) {
                console.error('Errore inizializzazione:', error);
                app.initialized = false;
            }
        }

        // Start
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>
