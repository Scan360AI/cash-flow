<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Cassa</title>
    <link rel="stylesheet" href="styles.css">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
</head>
<body>
    <div class="app-container">
        <!-- Header con saldi -->
        <header class="app-header">
            <h1 class="header-title">Gestione Cassa</h1>
            <div class="saldi-container">
                <div class="saldo-card">
                    <div class="saldo-label">Saldo Contabile</div>
                    <div class="saldo-value" id="saldo-contabile">€ 0,00</div>
                </div>
                <div class="saldo-card">
                    <div class="saldo-label">Saldo Disponibile</div>
                    <div class="saldo-value" id="saldo-disponibile">€ 0,00</div>
                </div>
            </div>
        </header>

        <!-- Sidebar con menu -->
        <aside class="app-sidebar">
            <div class="sidebar-menu">
                <div class="menu-item active">
                    <i data-lucide="credit-card" class="menu-icon"></i>
                    <span>Movimenti</span>
                </div>
                <div class="menu-item">
                    <i data-lucide="archive" class="menu-icon"></i>
                    <span>Storico</span>
                </div>
            </div>
            
            <!-- Impostazioni veloci -->
            <div class="card" style="margin-top: 2rem;">
                <div class="card-header">
                    <h2 class="card-title">Impostazioni</h2>
                </div>
                <div class="card-content">
                    <div class="form-group">
                        <label class="form-label" for="saldo-iniziale-quick">Saldo Iniziale (€)</label>
                        <input type="number" id="saldo-iniziale-quick" class="form-input" 
                               step="0.01" placeholder="0,00">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="limite-scoperto-quick">Limite Scoperto (€)</label>
                        <input type="number" id="limite-scoperto-quick" class="form-input" 
                               step="0.01" min="0" placeholder="0,00">
                    </div>
                    
                    <button type="button" id="salva-impostazioni-quick" class="btn btn-secondary" 
                            style="width: 100%;">
                        <i data-lucide="save" style="width: 16px; height: 16px;"></i>
                        Salva
                    </button>
                </div>
            </div>
        </aside>

        <!-- Main content -->
        <main class="app-main">
            <div class="main-header">
                <h2>Movimenti Attivi</h2>
                <div class="main-actions">
                    <button class="btn btn-primary" id="add-movimento-btn">
                        <i data-lucide="plus" style="width: 16px; height: 16px;"></i>
                        Nuovo Movimento
                    </button>
                    <button class="btn btn-success" id="storicizza-btn">
                        <i data-lucide="archive" style="width: 16px; height: 16px;"></i>
                        Storicizza Eseguiti
                    </button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-content" style="padding: 0;">
                    <div class="table-container">
                        <table class="movimenti-table">
                            <thead>
                                <tr>
                                    <th>Data</th>
                                    <th>Descrizione</th>
                                    <th>Categoria</th>
                                    <th>Importo</th>
                                    <th>Tipo</th>
                                    <th>Stato</th>
                                    <th>Saldo Contabile</th>
                                    <th>Azioni</th>
                                </tr>
                            </thead>
                            <tbody id="movimenti-tbody">
                                <!-- Movimenti generati dinamicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal per movimento -->
    <div id="movimento-modal" class="modal-overlay" style="display: none;">
        <div class="modal large">
            <div class="modal-header">
                <h3 class="modal-title" id="movimento-modal-title">Nuovo Movimento</h3>
                <button class="modal-close" id="movimento-modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <form id="movimento-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="data">Data *</label>
                            <input type="date" id="data" class="form-input" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="stato">Stato</label>
                            <select id="stato" class="form-select" required>
                                <option value="previsto">Previsto</option>
                                <option value="eseguito">Eseguito</option>
                                <option value="annullato">Annullato</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="descrizione">Descrizione *</label>
                        <input type="text" id="descrizione" class="form-input" required 
                               placeholder="Es: Pagamento fornitore ABC">
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="tipo">Tipo *</label>
                            <select id="tipo" class="form-select" required>
                                <option value="">Seleziona tipo</option>
                                <option value="entrata">Entrata</option>
                                <option value="uscita">Uscita</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="importo">Importo (€) *</label>
                            <input type="number" id="importo" class="form-input" 
                                   step="0.01" min="0.01" required placeholder="0,00">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="categoria">Categoria *</label>
                        <select id="categoria" class="form-select" required>
                            <option value="">Seleziona categoria</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="movimento-modal-cancel">
                    <i data-lucide="x" style="width: 16px; height: 16px;"></i>
                    Annulla
                </button>
                <button type="submit" form="movimento-form" class="btn btn-primary" id="movimento-modal-save">
                    <i data-lucide="save" style="width: 16px; height: 16px;"></i>
                    <span id="movimento-save-text">Salva Movimento</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modal per conferme -->
    <div id="modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Conferma</h3>
                <button class="modal-close" id="modal-close">&times;</button>
            </div>
            <div class="modal-body">
                <p id="modal-message">Sei sicuro?</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="modal-cancel">Annulla</button>
                <button class="btn btn-danger" id="modal-confirm">Conferma</button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="config.js"></script>
    <script>
        // === CONFIGURAZIONE DEFINITIVA ===
        window.SUPABASE_CONFIG = window.SUPABASE_CONFIG || SUPABASE_CONFIG || {
            url: 'https://pnrjsisykqzwvcdjdyri.supabase.co',
            key: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBucmpzaXN5a3F6d3ZjZGpkeXJpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg4MDM5MzAsImV4cCI6MjA3NDM3OTkzMH0.vpauNA2NYZlA9vIW7SItUvM3GuOxLAvFLdUQehNCQ-0'
        };
        
        window.CONFIG_UTILS = window.CONFIG_UTILS || CONFIG_UTILS || {
            formatCurrency: (amount) => {
                return new Intl.NumberFormat('it-IT', {
                    style: 'currency',
                    currency: 'EUR',
                    minimumFractionDigits: 2
                }).format(amount);
            },
            formatDate: (date) => {
                return new Date(date).toLocaleDateString('it-IT');
            }
        };

        // === STATO GLOBALE ===
        const app = {
            movimenti: [],
            movimentiStorico: [],
            categorie: [],
            settings: {
                saldoIniziale: 0,
                limiteScoperto: 0
            },
            saldoContabile: 0,
            saldoDisponibile: 0,
            editingId: null,
            initialized: false,
            currentView: 'movimenti' // 'movimenti' o 'storico'
        };

        let supabaseClient;

        // === FUNZIONI DATABASE ===
        async function loadCategorie() {
            console.log('Caricando categorie...');
            const { data, error } = await supabaseClient
                .from('categorie')
                .select('*')
                .eq('attiva', true)
                .order('tipo', { ascending: true })
                .order('nome', { ascending: true });
            
            if (error) throw error;
            
            app.categorie = data || [];
            updateCategorieSelect();
        }

        async function loadSettings() {
            console.log('Caricando impostazioni...');
            const { data, error } = await supabaseClient
                .from('settings')
                .select('*')
                .limit(1);
            
            if (error) throw error;
            
            if (data && data.length > 0) {
                app.settings = {
                    saldoIniziale: parseFloat(data[0].saldo_iniziale) || 0,
                    limiteScoperto: parseFloat(data[0].limite_scoperto) || 0
                };
            }
            
            updateSettingsForm();
        }

        async function loadMovimenti() {
            console.log('Caricando movimenti...');
            const { data, error } = await supabaseClient
                .from('movimenti')
                .select(`*, categoria:categorie(nome, colore)`)
                .eq('storicizzato', false) // Solo movimenti attivi
                .order('data', { ascending: true });
            
            if (error) {
                // Se la colonna storicizzato non esiste, carica tutti i non-annullati
                if (error.code === 'PGRST116' || error.message.includes('storicizzato')) {
                    console.log('Colonna storicizzato non esiste, usando filtro per stato...');
                    const { data: allData, error: fallbackError } = await supabaseClient
                        .from('movimenti')
                        .select(`*, categoria:categorie(nome, colore)`)
                        .neq('stato', 'annullato') // Escludi solo gli annullati
                        .order('data', { ascending: true });
                    
                    if (fallbackError) throw fallbackError;
                    app.movimenti = allData || [];
                } else {
                    throw error;
                }
            } else {
                app.movimenti = data || [];
            }
            
            renderTabella();
            updateSaldi();
        }

        async function loadMovimentiStorico() {
            console.log('Caricando movimenti storico...');
            const { data, error } = await supabaseClient
                .from('movimenti')
                .select(`*, categoria:categorie(nome, colore)`)
                .eq('storicizzato', true) // Solo movimenti storicizzati
                .order('storicizzato_at', { ascending: false }); // Più recenti prima
            
            if (error) {
                // Se la colonna storicizzato non esiste, carica gli annullati
                if (error.code === 'PGRST116' || error.message.includes('storicizzato')) {
                    console.log('Colonna storicizzato non esiste, caricando movimenti annullati...');
                    const { data: allData, error: fallbackError } = await supabaseClient
                        .from('movimenti')
                        .select(`*, categoria:categorie(nome, colore)`)
                        .eq('stato', 'annullato')
                        .order('updated_at', { ascending: false });
                    
                    if (fallbackError) throw fallbackError;
                    app.movimentiStorico = allData || [];
                } else {
                    throw error;
                }
            } else {
                app.movimentiStorico = data || [];
            }
            
            renderTabellaStorico();
        }

        async function saveMovimento(movimento) {
            const { data, error } = await supabaseClient
                .from('movimenti')
                .insert([movimento])
                .select();
            
            if (error) throw error;
            await loadMovimenti();
            return data[0];
        }

        async function updateMovimento(id, updates) {
            const { data, error } = await supabaseClient
                .from('movimenti')
                .update(updates)
                .eq('id', id)
                .select();
            
            if (error) throw error;
            await loadMovimenti();
            return data[0];
        }

        async function deleteMovimento(id) {
            const { error } = await supabaseClient
                .from('movimenti')
                .delete()
                .eq('id', id);
            
            if (error) throw error;
            await loadMovimenti();
        }

        async function saveSettings() {
            const settings = {
                saldo_iniziale: parseFloat(document.getElementById('saldo-iniziale-quick').value) || 0,
                limite_scoperto: parseFloat(document.getElementById('limite-scoperto-quick').value) || 0,
                updated_at: new Date().toISOString()
            };

            const { error } = await supabaseClient
                .from('settings')
                .upsert(settings);
            
            if (error) throw error;
            
            app.settings.saldoIniziale = settings.saldo_iniziale;
            app.settings.limiteScoperto = settings.limite_scoperto;
            updateSaldi();
        }

        // === FUNZIONI UI ===
        function updateCategorieSelect() {
            const select = document.getElementById('categoria');
            if (!select) return;
            
            const currentValue = select.value;
            const firstOption = select.children[0];
            select.innerHTML = '';
            if (firstOption) select.appendChild(firstOption);
            
            ['entrata', 'uscita'].forEach(tipo => {
                const categorieTipo = app.categorie.filter(c => c.tipo === tipo);
                if (categorieTipo.length > 0) {
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = tipo.charAt(0).toUpperCase() + tipo.slice(1) + 'e';
                    
                    categorieTipo.forEach(categoria => {
                        const option = document.createElement('option');
                        option.value = categoria.id;
                        option.textContent = categoria.nome;
                        optgroup.appendChild(option);
                    });
                    
                    select.appendChild(optgroup);
                }
            });
            
            if (currentValue) select.value = currentValue;
        }

        function updateSettingsForm() {
            const saldoEl = document.getElementById('saldo-iniziale-quick');
            const scopertorEl = document.getElementById('limite-scoperto-quick');
            
            if (saldoEl) saldoEl.value = app.settings.saldoIniziale;
            if (scopertorEl) scopertorEl.value = app.settings.limiteScoperto;
        }

        function updateSaldi() {
            const movimentiValidi = app.movimenti.filter(m => m.stato !== 'annullato');
            
            const entrate = movimentiValidi
                .filter(m => m.tipo === 'entrata')
                .reduce((sum, m) => sum + Math.abs(parseFloat(m.importo)), 0);
            
            const uscite = movimentiValidi
                .filter(m => m.tipo === 'uscita')
                .reduce((sum, m) => sum + Math.abs(parseFloat(m.importo)), 0);
            
            app.saldoContabile = app.settings.saldoIniziale + entrate - uscite;
            app.saldoDisponibile = app.saldoContabile - app.settings.limiteScoperto;
            
            const saldoContabileEl = document.getElementById('saldo-contabile');
            const saldoDisponibileEl = document.getElementById('saldo-disponibile');
            
            if (saldoContabileEl) saldoContabileEl.textContent = window.CONFIG_UTILS.formatCurrency(app.saldoContabile);
            if (saldoDisponibileEl) saldoDisponibileEl.textContent = window.CONFIG_UTILS.formatCurrency(app.saldoDisponibile);
        }

        function renderTabella() {
            const tbody = document.getElementById('movimenti-tbody');
            if (!tbody) return;
            
            if (app.movimenti.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 3rem; color: var(--gray-500);">
                            Nessun movimento presente. Clicca "Nuovo Movimento" per iniziare.
                        </td>
                    </tr>
                `;
                return;
            }
            
            // Calcolo saldi progressivi
            let saldoProgressivo = app.settings.saldoIniziale;
            
            const movimentiConSaldo = [...app.movimenti]
                .sort((a, b) => new Date(a.data) - new Date(b.data))
                .map(movimento => {
                    if (movimento.stato !== 'annullato') {
                        if (movimento.tipo === 'entrata') {
                            saldoProgressivo += Math.abs(parseFloat(movimento.importo));
                        } else {
                            saldoProgressivo -= Math.abs(parseFloat(movimento.importo));
                        }
                    }
                    
                    let saldoClass = 'saldo-positivo';
                    let saldoIcon = 'check-circle';
                    
                    if (saldoProgressivo < 0) {
                        if (saldoProgressivo > -app.settings.limiteScoperto) {
                            saldoClass = 'saldo-allerta';
                            saldoIcon = 'alert-triangle';
                        } else {
                            saldoClass = 'saldo-critico';
                            saldoIcon = 'x-circle';
                        }
                    }
                    
                    return { ...movimento, saldoProgressivo, saldoClass, saldoIcon };
                });
            
            tbody.innerHTML = movimentiConSaldo.map(movimento => `
                <tr class="movimento-row" data-id="${movimento.id}">
                    <td>${window.CONFIG_UTILS.formatDate(movimento.data)}</td>
                    <td>${movimento.descrizione}</td>
                    <td>
                        <span class="categoria-badge" style="background-color: ${movimento.categoria?.colore || '#e5e7eb'}20;">
                            ${movimento.categoria?.nome || 'N/A'}
                        </span>
                    </td>
                    <td class="${movimento.tipo === 'entrata' ? 'tipo-entrata' : 'tipo-uscita'}">
                        ${movimento.tipo === 'entrata' ? '+' : '−'}${window.CONFIG_UTILS.formatCurrency(Math.abs(movimento.importo))}
                    </td>
                    <td class="${movimento.tipo === 'entrata' ? 'tipo-entrata' : 'tipo-uscita'}">
                        ${movimento.tipo.charAt(0).toUpperCase() + movimento.tipo.slice(1)}
                    </td>
                    <td>
                        <span class="status-badge status-${movimento.stato}">
                            ${movimento.stato}
                        </span>
                    </td>
                    <td class="saldo-progressivo ${movimento.saldoClass}">
                        <div class="saldo-container">
                            <i data-lucide="${movimento.saldoIcon}" class="saldo-icon"></i>
                            <span class="saldo-amount">${window.CONFIG_UTILS.formatCurrency(movimento.saldoProgressivo)}</span>
                        </div>
                    </td>
                    <td class="actions-cell">
                        <div class="action-buttons">
                            <button class="btn-icon ${movimento.stato === 'eseguito' ? 'executed' : 'pending'}" 
                                    onclick="toggleEseguito('${movimento.id}')">
                                <i data-lucide="${movimento.stato === 'eseguito' ? 'check-circle-2' : 'circle'}"></i>
                            </button>
                            <button class="btn-icon edit" onclick="editMovimento('${movimento.id}')">
                                <i data-lucide="edit"></i>
                            </button>
                            <button class="btn-icon duplicate" onclick="duplicateMovimento('${movimento.id}')">
                                <i data-lucide="copy"></i>
                            </button>
                            <button class="btn-icon delete" onclick="confirmDelete('${movimento.id}')">
                                <i data-lucide="trash-2"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
        function renderTabellaStorico() {
            const tbody = document.getElementById('movimenti-tbody');
            if (!tbody) return;
            
            if (app.movimentiStorico.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" style="text-align: center; padding: 3rem; color: var(--gray-500);">
                            Nessun movimento nello storico.
                        </td>
                    </tr>
                `;
                return;
            }
            
            tbody.innerHTML = app.movimentiStorico.map(movimento => `
                <tr class="movimento-row storico-row" data-id="${movimento.id}">
                    <td>${window.CONFIG_UTILS.formatDate(movimento.data)}</td>
                    <td>${movimento.descrizione}</td>
                    <td>
                        <span class="categoria-badge" style="background-color: ${movimento.categoria?.colore || '#e5e7eb'}20;">
                            ${movimento.categoria?.nome || 'N/A'}
                        </span>
                    </td>
                    <td class="${movimento.tipo === 'entrata' ? 'tipo-entrata' : 'tipo-uscita'}">
                        ${movimento.tipo === 'entrata' ? '+' : '−'}${window.CONFIG_UTILS.formatCurrency(Math.abs(movimento.importo))}
                    </td>
                    <td class="${movimento.tipo === 'entrata' ? 'tipo-entrata' : 'tipo-uscita'}">
                        ${movimento.tipo.charAt(0).toUpperCase() + movimento.tipo.slice(1)}
                    </td>
                    <td>
                        <span class="status-badge status-eseguito">
                            Storicizzato
                        </span>
                    </td>
                    <td class="saldo-progressivo">
                        <div class="saldo-container">
                            <i data-lucide="archive" class="saldo-icon" style="color: var(--gray-400);"></i>
                            <span class="saldo-amount" style="color: var(--gray-500);">Archiviato</span>
                        </div>
                    </td>
                    <td class="actions-cell">
                        <div class="action-buttons">
                            <button class="btn-icon restore" onclick="ripristinaMovimento('${movimento.id}')" title="Ripristina">
                                <i data-lucide="undo-2"></i>
                            </button>
                            <button class="btn-icon delete" onclick="eliminaDefinitivamente('${movimento.id}')" title="Elimina definitivamente">
                                <i data-lucide="trash-2"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
            
            lucide.createIcons();
        }

        // === MODAL FUNCTIONS ===
        function showMovimentoModal(movimento = null) {
            const modal = document.getElementById('movimento-modal');
            if (!modal) return;
            
            if (movimento) {
                document.getElementById('movimento-modal-title').textContent = 'Modifica Movimento';
                document.getElementById('movimento-save-text').textContent = 'Aggiorna';
                
                document.getElementById('data').value = movimento.data;
                document.getElementById('descrizione').value = movimento.descrizione;
                document.getElementById('importo').value = Math.abs(movimento.importo);
                document.getElementById('tipo').value = movimento.tipo;
                document.getElementById('categoria').value = movimento.categoria_id;
                document.getElementById('stato').value = movimento.stato;
                
                app.editingId = movimento.id;
            } else {
                document.getElementById('movimento-modal-title').textContent = 'Nuovo Movimento';
                document.getElementById('movimento-save-text').textContent = 'Salva';
                
                document.getElementById('movimento-form').reset();
                document.getElementById('data').valueAsDate = new Date();
                app.editingId = null;
            }
            
            updateCategorieSelect();
            modal.style.display = 'flex';
        }

        function hideMovimentoModal() {
            const modal = document.getElementById('movimento-modal');
            if (modal) modal.style.display = 'none';
        }

        function showConfirmModal(title, message, onConfirm) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            document.getElementById('modal-overlay').style.display = 'flex';
            
            document.getElementById('modal-confirm').onclick = () => {
                document.getElementById('modal-overlay').style.display = 'none';
                onConfirm();
            };
        }

        // === NAVIGAZIONE VISTE ===
        function switchToMovimenti() {
            app.currentView = 'movimenti';
            document.querySelector('.main-header h2').textContent = 'Movimenti Attivi';
            document.querySelector('.menu-item.active').classList.remove('active');
            document.querySelectorAll('.menu-item')[0].classList.add('active');
            
            // Mostra i pulsanti per movimenti attivi
            document.getElementById('add-movimento-btn').style.display = 'inline-flex';
            document.getElementById('storicizza-btn').style.display = 'inline-flex';
            
            renderTabella();
        }

        function switchToStorico() {
            app.currentView = 'storico';
            document.querySelector('.main-header h2').textContent = 'Storico Movimenti';
            document.querySelector('.menu-item.active').classList.remove('active');
            document.querySelectorAll('.menu-item')[1].classList.add('active');
            
            // Nascondi i pulsanti per lo storico
            document.getElementById('add-movimento-btn').style.display = 'none';
            document.getElementById('storicizza-btn').style.display = 'none';
            
            loadMovimentiStorico();
        }

        // === AZIONI STORICO ===
        async function ripristinaMovimento(id) {
            try {
                const { error } = await supabaseClient
                    .from('movimenti')
                    .update({ 
                        storicizzato: false, 
                        storicizzato_at: null,
                        stato: 'eseguito' // Ripristina come eseguito
                    })
                    .eq('id', id);
                
                if (error) {
                    // Fallback se non c'è colonna storicizzato
                    const { error: fallbackError } = await supabaseClient
                        .from('movimenti')
                        .update({ stato: 'eseguito' })
                        .eq('id', id);
                    
                    if (fallbackError) throw fallbackError;
                }
                
                await loadMovimentiStorico();
                await loadMovimenti(); // Ricarica anche i movimenti attivi
                alert('Movimento ripristinato');
            } catch (error) {
                console.error('Errore ripristino:', error);
                alert('Errore durante il ripristino');
            }
        }

        async function eliminaDefinitivamente(id) {
            showConfirmModal(
                'Elimina Definitivamente',
                'Sei sicuro? Questa operazione non può essere annullata.',
                async () => {
                    try {
                        await deleteMovimento(id);
                        await loadMovimentiStorico();
                        alert('Movimento eliminato definitivamente');
                    } catch (error) {
                        console.error('Errore eliminazione:', error);
                        alert('Errore durante l\'eliminazione');
                    }
                }
            );
        }
        async function toggleEseguito(id) {
            const movimento = app.movimenti.find(m => m.id === id);
            if (!movimento) return;
            
            const nuovoStato = movimento.stato === 'eseguito' ? 'previsto' : 'eseguito';
            await updateMovimento(id, { stato: nuovoStato });
        }

        function editMovimento(id) {
            const movimento = app.movimenti.find(m => m.id === id);
            if (movimento) showMovimentoModal(movimento);
        }

        async function duplicateMovimento(id) {
            const movimento = app.movimenti.find(m => m.id === id);
            if (!movimento) return;
            
            const duplicato = {
                data: movimento.data,
                descrizione: movimento.descrizione + ' (copia)',
                importo: movimento.importo,
                categoria_id: movimento.categoria_id,
                tipo: movimento.tipo,
                stato: 'previsto'
            };
            
            await saveMovimento(duplicato);
        }

        function confirmDelete(id) {
            showConfirmModal(
                'Elimina Movimento',
                'Sei sicuro di voler eliminare questo movimento?',
                () => deleteMovimento(id)
            );
        }

        async function storicizzaEseguiti() {
            const eseguiti = app.movimenti.filter(m => m.stato === 'eseguito');
            if (eseguiti.length === 0) {
                alert('Nessun movimento eseguito da storicizzare');
                return;
            }
            
            showConfirmModal(
                'Storicizza Movimenti',
                `Vuoi spostare ${eseguiti.length} movimenti nello storico?`,
                async () => {
                    try {
                        const ids = eseguiti.map(m => m.id);
                        
                        // Tenta di aggiungere le colonne se non esistono
                        try {
                            await supabaseClient.rpc('exec_sql', {
                                sql: `
                                    ALTER TABLE movimenti 
                                    ADD COLUMN IF NOT EXISTS storicizzato BOOLEAN DEFAULT false,
                                    ADD COLUMN IF NOT EXISTS storicizzato_at TIMESTAMP WITH TIME ZONE;
                                    
                                    UPDATE movimenti 
                                    SET storicizzato = false 
                                    WHERE storicizzato IS NULL;
                                `
                            });
                            console.log('Colonne storicizzato aggiunte/verificate');
                        } catch (sqlError) {
                            console.log('Impossibile eseguire SQL:', sqlError.message);
                        }
                        
                        // Prova a storicizzare
                        let { error } = await supabaseClient
                            .from('movimenti')
                            .update({ 
                                storicizzato: true, 
                                storicizzato_at: new Date().toISOString() 
                            })
                            .in('id', ids);
                        
                        if (error && (error.message.includes('storicizzato') || error.code === 'PGRST116')) {
                            // Fallback: usa un campo esistente per marcare come storicizzato
                            console.log('Fallback: marcando con descrizione speciale');
                            
                            for (const movimento of eseguiti) {
                                await supabaseClient
                                    .from('movimenti')
                                    .update({ 
                                        descrizione: `[STORICIZZATO] ${movimento.descrizione}`,
                                        updated_at: new Date().toISOString()
                                    })
                                    .eq('id', movimento.id);
                            }
                            
                            alert(`${ids.length} movimenti spostati nello storico (modalità compatibilità)`);
                        } else if (error) {
                            throw error;
                        } else {
                            alert(`${ids.length} movimenti spostati nello storico`);
                        }
                        
                        await loadMovimenti();
                        
                    } catch (error) {
                        console.error('Errore storicizzazione:', error);
                        alert('Errore durante la storicizzazione: ' + error.message);
                    }
                }
            );
        }

        // === INIZIALIZZAZIONE ===
        async function initApp() {
            if (app.initialized) {
                console.log('App già inizializzata');
                return;
            }
            
            app.initialized = true;
            
            try {
                console.log('Inizializzando app...');
                
                // Inizializza Supabase
                const { createClient } = supabase;
                supabaseClient = createClient(window.SUPABASE_CONFIG.url, window.SUPABASE_CONFIG.key);
                
                // Carica dati
                await loadCategorie();
                await loadSettings(); 
                await loadMovimenti();
                
                // Event listeners
                document.getElementById('add-movimento-btn').addEventListener('click', () => showMovimentoModal());
                document.getElementById('storicizza-btn').addEventListener('click', storicizzaEseguiti);
                document.getElementById('salva-impostazioni-quick').addEventListener('click', saveSettings);
                
                // Menu navigation
                document.querySelectorAll('.menu-item')[0].addEventListener('click', switchToMovimenti);
                document.querySelectorAll('.menu-item')[1].addEventListener('click', switchToStorico);
                
                // Modal listeners
                document.getElementById('movimento-modal-close').addEventListener('click', hideMovimentoModal);
                document.getElementById('movimento-modal-cancel').addEventListener('click', hideMovimentoModal);
                document.getElementById('modal-close').addEventListener('click', () => document.getElementById('modal-overlay').style.display = 'none');
                document.getElementById('modal-cancel').addEventListener('click', () => document.getElementById('modal-overlay').style.display = 'none');
                
                // Form submit
                document.getElementById('movimento-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    
                    const formData = {
                        data: document.getElementById('data').value,
                        descrizione: document.getElementById('descrizione').value,
                        importo: parseFloat(document.getElementById('importo').value),
                        categoria_id: document.getElementById('categoria').value,
                        tipo: document.getElementById('tipo').value,
                        stato: document.getElementById('stato').value
                    };
                    
                    if (app.editingId) {
                        await updateMovimento(app.editingId, formData);
                    } else {
                        await saveMovimento(formData);
                    }
                    
                    hideMovimentoModal();
                });
                
                console.log('✅ App inizializzata con successo');
                lucide.createIcons();
                
            } catch (error) {
                console.error('Errore inizializzazione:', error);
                app.initialized = false;
            }
        }

        // Start app
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>

        // Start app
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }
    </script>
</body>
</html>
